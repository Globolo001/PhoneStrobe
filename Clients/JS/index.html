<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Sync Client</title>
  </head>
  <body>
    <button onclick="sendEffectCommand('strobeOn')">Strobe On</button>
    <button onclick="sendEffectCommand('strobeOff')">Strobe Off</button>
    <button onclick="sendSyncTimeCommand()">Sync Time</button>
    <script>
      // Initialize WebSocket connection
      const ws = new WebSocket("ws://localhost:42187");

      // Queue of effects to execute
      const effectQueue = [];

      // Handle incoming messages
      ws.onmessage = (event) => {
        const message = event.data;
        console.log(`Received message: ${message}`);

        if (message.startsWith("$EXEC_EFCT")) {
          // Extract effect and timecode from message
          const parts = message.split(" ");
          const effect = parts[1];
          const timecode = parseFloat(parts[2]);

          // Add effect to queue
          effectQueue.push({effect, timecode});

          console.log(`Added effect ${effect} to queue. Executing at ${timecode}`);
        }

        // Initalize time offset
        if (message.startsWith("$REQUEST_TIME")) {
          const localTime = Date.now() / 1000;
          ws.send(localTime)
        }

        // Set client time offset
        if (message.startsWith("$YOUR_OFFSET")) {
          // Extract client time offset from message
          const clientOffset = parseFloat(message.split(" ")[1]);
          localStorage.setItem("timeOffset", clientOffset.toString());
          console.log(`Set client time offset to: ${clientOffset}`);
        }
      };

      ws.onopen = function (event) {
        console.log("WebSocket opened");
      };

      // Start executing effects from queue
      setInterval(() => {
        const currentTime = getNormalizedTime();
        while (effectQueue.length > 0 && effectQueue[0].timecode < currentTime) {
          const { effect } = effectQueue.shift();
          console.log(`Executing effect ${effect}; Timecode: ${currentTime}`);
          
          if(effect == "strobeOn"){
            document.body.style.background = "black";
          }else if(effect == "strobeOff") {
            document.body.style.background = "white";
          }

          console.log(effectQueue);
        }
      }, 1); // Check every millisecond for new effects to execute

      // Function to send an effect command to the server
      function sendEffectCommand(effect) {
        const timeOfExecution = getNormalizedTime() + 2; // add 2 seconds to synced time
        const message = `$EFCT ${effect} ${timeOfExecution}`;
        console.log(`Sending message: ${message}`);
        ws.send(message);
      }

      // Function to send a sync time command to the server
      function sendSyncTimeCommand() {
        const message = "$SYNC_TIME";
        console.log(`Sending message: ${message}`);
        ws.send(message);
      }

      function getNormalizedTime(){
        return Date.now() / 1000 + parseFloat(localStorage.getItem("timeOffset"));
      }
    </script>
  </body>
</html>
